<html>
<head>
    <title>Registry-Liste</title>
    <link rel="stylesheet" href="https://walm-dc.github.io/WebTools/public/mattStyle.css">
    <script src="https://walm-dc.github.io/WebTools/public/jquery-3.7.1.min.js"></script>
    <script src="https://walm-dc.github.io/WebTools/public/ddtf.js"></script>
    <script src="https://walm-dc.github.io/WebTools/public/mattQuery.js"></script>
    <!-- <script src="mattQuery.js"></script> -->
    <style>
        .markets{
            padding-left: 20px;
        }
        #errorDiv{
            position: absolute;
            top: 66px;
            left: 8px;
            padding: 10px;
            border: 2px solid red;
            background-color: #ffe5e5;
            z-index: 10;
            height: 20px;
            max-height: 90vh;
            overflow: hidden;
        }
        #errorDiv h3{
            margin: 0 0 9px 0;
            color: red;
        }
        #errorDiv h4{
            margin: 0 0 9px 0;
            color: darkslateblue;
            font-size: 1.17em;
        }
        #errorDiv table td, #errorDiv table th{
            max-width: 600px;
        }
        #errorDiv #innerErrodDiv{
            color: dodgerblue;
            cursor: pointer;
            text-decoration: underline;
            position: absolute;
            right: 9px;
        }
        table{
            margin-bottom: 9px;
        }
    </style>
</head>
<body>
    <div id="topDiv"></div>
    <div class="masterDiv">
        <!-- <div class="topDiv">
            <h2>Registry-Liste</h2>
        </div> -->
        <div id="errorDiv"><div id="innerErrodDiv">Details anzeigen &#9660;</div></div>
        <div>
            <div class="resultDiv">
                <h3>Anzahl in der aktuellen Auflistung: <span id="myCounter"></span></h3>
                <img src="refresh-button.png" class="emptySearch" title="Suche leeren" alt="Suche leeren"><input type="text" id="myInput" placeholder="Allgemeine Suche auf alle Felder...">
                <div class="div_before_table igServer">
                    <table id="myTable" cellspacing="0" cellpadding="0">
                        <tr>
                            <th>ID</th>
                            <th>Marke</th>
                            <th>Modellname</th>
                            <th>3D Domain</th>
                            <th>Schiene</th>
                            <th>Address + Markets</th>
                        </tr>
                    </table>
                </div>
            </div>    
        </div>
    </div>
</body>
<script>
    injectTabs();

    var langCheck = ['AT', 'DE', 'CH', 'CZ', 'SK', 'FR', 'SE', 'HU', 'SI', 'PL', 'RO'];
    var combinedRegistry = [], registryErrors = [];
    function countColumns(){
        $('#myCounter').html(($('table tr').length-1)-($('table tr[style="display: none;"]').length));
    }
    function sortList(a, b) {
        let ca = a.ID.toLowerCase();
        let cb = b.ID.toLowerCase();
        let ba = a.Scope.toLowerCase();
        let bb = b.Scope.toLowerCase();
        let ma = a.FileName.toLowerCase();
        let mb = b.FileName.toLowerCase();
        if(ca !== cb) return (ca < cb) ? -1 : 1;
        if(ba !== bb) return (ba < bb) ? -1 : 1;
        return (ma < mb) ? -1 : 1;
    }
    $('#myInput').on('keydown', function(e) {
        if (e.which === 13) { // Check if the Enter key is pressed (key code 13)
            if($(this).val() === ""){
                removeHighlights();
                $('#myTable tr').show();
            } else {
                filterTable();
            }
        }
    });
    $('.emptySearch').on('click', function(){
        $('#myInput').val('');
        removeHighlights();
        $('#myTable tr').show();
        countColumns();
    });
    $('#innerErrodDiv').on('click', function(){
        var errorDiv = $('#errorDiv');
        if(errorDiv.css('height') !== '20px'){
            errorDiv.css('height', '20px');
            errorDiv.css('overflow', 'hidden');
            $('#innerErrodDiv').html('Details anzeigen &#9660;');
        } else {
            errorDiv.css('height', 'auto');
            errorDiv.css('overflow', 'auto');
            $('#innerErrodDiv').html('Details ausblenden &#9650;');
        }
    });
    function combineRegistries(curRegistry, fileName){
        $.each(curRegistry.Domains, function( key, value ) {
            var addressArray = [], marketArray = [], pathArray = [];
            if(value.ComService === undefined) return; //skip entries without address
            var entry = {};
            if(value.ComService.Setups === undefined){
                $(value.ComService.Markets).each(function(mIndex, mValue) {
                    $.each(mValue, function(key, val) {
                        marketArray.push(`${key}: ${val}`);
                    });
                });
                addressArray.push(value.ComService.Address.replace('https://ig-creator.xxxlgroup.com/idm/', '').replace('lokal/', '')+
                '<br><span class="markets">Markets: '+marketArray.join(', ')+'</span>');
                pathArray.push(value.ComService.Address.replace('https://ig-creator.xxxlgroup.com/idm/', '').replace('lokal/', ''));
            } else {
                addressArray = [];
                $.each(value.ComService.Setups, function( setupKey, setupValue ) {
                    marketArray = [];
                    $(setupValue).each(function(mIndex, mValue) {
                        $.each(mValue.Markets, function(key, val) {
                            marketArray.push(`${key}: ${val}`);
                        });
                    });
                    addressArray.push(setupValue.Address.replace('https://ig-creator.xxxlgroup.com/idm/', '').replace('lokal/', '')+
                    '<br><span class="markets">Markets: '+marketArray.join(', ')+'</span>');
                    pathArray.push(setupValue.Address.replace('https://ig-creator.xxxlgroup.com/idm/', '').replace('lokal/', ''));
                });
            }
            entry = {
                ID: key,
                FileName: fileName,
                Scope: value.Scope,
                Address: addressArray,
                Path: pathArray
            }

            const isDuplicate = combinedRegistry.some(item => item.ID.toLowerCase() === entry.ID.toLowerCase() && item.Scope.toLowerCase() === entry.Scope.toLowerCase() && item.FileName !== entry.FileName);

            if (!isDuplicate) {
                combinedRegistry.push(entry);
            } else {
                registryErrors.push(entry);
            }
        })
        var xmlMismatches = [];
        $.each(registryErrors, function( index, errorEntry ) {
            $.each(combinedRegistry, function( cIndex, cEntry ) {
                if((cEntry.ID === errorEntry.ID && cEntry.Scope === errorEntry.Scope) && cEntry.FileName !== errorEntry.FileName){
                    if(cEntry.Path.join(',') !== errorEntry.Path.join(',')){
                        xmlMismatches.push('<table><tr><th>'+errorEntry.ID+'</th><th>'+errorEntry.Scope+':</th></tr>'+
                        '<tr><td>'+cEntry.FileName+'.json:</td><td>'+cEntry.Path.join(', ')+'</td></tr>'+
                        '<tr><td>'+errorEntry.FileName+'.json</td><td>'+errorEntry.Path.join(', ')+'</td></tr></table>');
                    }
                }
            });
        });
        if(fileName === 'registry'){
            var registryOnly = [];
            var sortArray = $.map(combinedRegistry, function(value, index) {return [value]});
            sortArray.sort(sortList);
            $.each(sortArray, function( index, registryEntry ) {
                $('#myTable').append('<tr>'+
                    '<td>'+registryEntry.ID+'</td>'+
                    '<td>'+registryEntry.Scope.split('.')[0].replace('XXXL', '')+'</td>'+
                    '<td>'+registryEntry.Scope.split('.')[1]+'</td>'+
                    '<td>'+registryEntry.Scope+'</td>'+
                    '<td>'+registryEntry.FileName+'</td>'+
                    '<td>'+registryEntry.Address.join('<br>')+'</td>'+
                '</tr>');
                if(registryEntry.FileName === 'registry'){
                    registryOnly.push('<tr><td>'+registryEntry.ID+'</td><td>'+registryEntry.Scope+'</td><td>'+registryEntry.Path.join('<br>')+'</td></tr>');
                }
            });
            if(xmlMismatches.length > 0){
                $('#errorDiv').append('<h3>ACHTUNG XML-Pfad-Unterschiede gefunden</h3>'+xmlMismatches.join('<br><br>'));
            }
            if(registryOnly.length > 0){
                $('#errorDiv').append('<h4>INFO '+registryOnly.length+' Eintr&auml;ge nur in der _registry.json gefunden</h4><table>'+registryOnly.join('')+'</table>');
            }
            jQuery('#myTable').ddTableFilter();
            countColumns()
        }
    }
    function readAndShowJSON(){
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry-moebelix.json", function( data ) {
            combineRegistries(data, 'moebelix');
        });
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry-moemax.json", function( data ) {
            combineRegistries(data, 'moemax');
        });
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry-xxxl.json", function( data ) {
            combineRegistries(data, 'xxxl');
        });
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry.json", function( data ) {
            combineRegistries(data, 'registry');
        });
    }
    readAndShowJSON();
</script>
</html>