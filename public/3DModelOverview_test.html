<html>
<head>
    <title>3D-Modell&uuml;bersicht</title>
    <link rel="stylesheet" href="https://walm-dc.github.io/WebTools/public/mattStyle.css">
    <script src="https://walm-dc.github.io/WebTools/public/jquery-3.7.1.min.js"></script>
    <script src="https://walm-dc.github.io/WebTools/public/table2csv.js"></script>
    <script src="https://walm-dc.github.io/WebTools/public/ddtf.js"></script>
    <script src="https://walm-dc.github.io/WebTools/public/mattQuery.js"></script>
    <style>
        .loading {
            background-image: url(loading.gif);
            background-repeat: no-repeat;
            min-height: 600px;
            background-position: center;
            background-size: 600px auto;
        }
    </style>
</head>
<body>
    <div id="topDiv"></div>
    <div class="masterDiv">
        <!-- <div class="topDiv">
            <h2>3D-Modell&uuml;bersicht</h2>
        </div> -->
        <div>
            <div class="resultDiv">
                <h3>Anzahl der gefilterten Artikel: <span id="myCounter"></span></h3>
                <h3>Anzahl der Varianten / Absprungpunkte: <span id="myVariantCounter"></span></h3>
                <h3 class="withButton">CSV Export: 
                    <button id="exportAll" class="pushable">
                        <span class="front">Alle Daten</span>
                    </button>
                    <button id="exportFiltered" class="pushable">
                        <span class="front">Gefilterte Daten</span>
                    </button>
                </h3>
                <img src="refresh-button.png" class="emptySearch" title="Suche leeren" alt="Suche leeren"><input type="text" id="myInput" placeholder="Allgemeine Suche auf alle Felder...">
                <div class="div_before_table loading">
                    <table id="myTable" cellspacing="0" cellpadding="0">
                        <tr>
                            <th>Hersteller</th>
                            <th>Marke</th>
                            <th>Modellname</th>
                            <th>3D Domain</th>
                            <th>Herkunft</th>
                            <th>Nummer</th>
                            <th>In Verwendung</th>
                            <th>Varianten</th>
                            <th>Absp.</th>
                            <th>Schiene</th>
                            <th>Land</th>
                            <th>W&auml;hrung</th>
                            <th>kaa1</th>
                            <th>entlastung</th>
                            <th>aktion</th>
                            <th>Beschreibung</th>
                            <th>Warengruppe</th>
                        </tr>
                    </table>
                </div>
            </div>    
        </div>
    </div>
</body>
<script>
    injectTabs();

    var intern = 0, extern = 0;
    var combinedRegistry = [];
    var countryShorts = {
        "LU": "xxxlutz",
        "MM": "moemax",
        "MX": "moebelix"
    }
    function sortList(a, b) {
        let ca = a.catalog.split('.')[0].replace('XXXL', '').toLowerCase();
        let cb = b.catalog.split('.')[0].replace('XXXL', '').toLowerCase();
        let ba = a.brandName.toLowerCase();
        let bb = b.brandName.toLowerCase();
        let ma = a.modelName.toLowerCase();
        let mb = b.modelName.toLowerCase();
        if(ca !== cb) return (ca < cb) ? -1 : 1;
        if(ba !== bb) return (ba < bb) ? -1 : 1;
        return (ma < mb) ? -1 : 1;
    }
    function countColumns(){
        $('#myCounter').html(($('table tr').length-1)-($('table tr[style="display: none;"]').length));
        var allVarantCount = 0, inactiveVariantCount = 0;
        $.each($('table tr'),function(id, val){
            if(typeof($(val).attr('variants'))!='undefined'){
                allVarantCount += parseInt($(val).attr('variants'));
            }
        })
        $.each($('table tr[style="display: none;"]'),function(id, val){
            if(typeof($(val).attr('variants'))!='undefined'){
                inactiveVariantCount += parseInt($(val).attr('variants'));
            }
        })
        $('#myVariantCounter').html(allVarantCount-inactiveVariantCount);
    }
    $('#myInput').on('keydown', function(e) {
        if (e.which === 13) { // Check if the Enter key is pressed (key code 13)
            if($(this).val() === ""){
                removeHighlights();
                $('#myTable tr').show();
            } else {
                filterTable();
            }
        }
    });
    $('.emptySearch').on('click', function(){
        $('#myInput').val('');
        removeHighlights();
        $('#myTable tr').show();
        countColumns();
    });
    // docu for plugin: https://www.jqueryscript.net/table/jQuery-Plugin-To-Export-Table-Data-To-CSV-File-table2csv.html
    $('#exportAll').on('click',function(){
        $("table").table2csv({  
            filename:'3D-Modellliste.csv',
            separator: ';',
            newline: '\n',
            quoteFields: false,
            trimContent: true,
            excludeHidden: false          
        });
    })
    $('#exportFiltered').on('click',function(){
        $("table").table2csv({
            filename:'3D-Modellliste-gefiltert.csv',
            separator: ';',
            newline: '\n',
            quoteFields: false,
            trimContent: true,
            excludeHidden: true
        });
    })
    function combineRegistries(curRegistry, fileName){
        $.each(curRegistry.Domains, function( key, value ) {
            var marketArray = [];
            if(value.ComService === undefined) return; //skip entries without address
            var entry = {};
            if(value.ComService.Setups === undefined){
                $(value.ComService.Markets).each(function(mIndex, mValue) {
                    $.each(mValue, function(key, val) {
                        marketArray.push(key.toLowerCase());
                    });
                });
            } else {
                $.each(value.ComService.Setups, function( setupKey, setupValue ) {
                    marketArray = [];
                    $(setupValue).each(function(mIndex, mValue) {
                        $.each(mValue.Markets, function(key, val) {
                            marketArray.push(key.toLowerCase());
                        });
                    });
                });
            }
            entry = {
                ID: value.Scope,
                FileName: fileName,
                Markets: marketArray,
            }

            const isDuplicate = combinedRegistry.some(item => item.ID.toLowerCase() === entry.ID.toLowerCase() && item.FileName !== entry.FileName);

            if (!isDuplicate) {
                combinedRegistry.push(entry);
            }
        })
    }
    function readAndShowJSON(){
        $.getJSON( "https://walm-dc.github.io/WebTools/public/list.json", function( data ) {
            var sortArray = $.map(data, function(value, index) {return [value]});
            sortArray.sort(sortList);
            $.each(sortArray, function(id, val){
                var online = '<td class="trueCol">Ja</td>';
                if(val.online=='false'){online = '<td class="falseCol">Nein</td>'}
                if(val.online==''){online = '<td></td>'}
                var konfig = '<td class="trueCol">Ja</td>';
                if(val.konfig=='false'){konfig = '<td class="falseCol">Nein</td>'}
                if(val.konfig==''){konfig = '<td></td>'}
                var storeUrl = countryShorts[val.brand]+'.'+val.locale;
                if(countryShorts[val.brand] === 'xxxlutz' && val.locale === 'si'){
                    storeUrl = 'xxxlesnina'+'.'+val.locale;
                }
                // var variants = val.productVariants.trim().slice(0, -1);
                var variantCount = val.productVariants.split("/").length;
                var variants = val.productVariants.split('/').map(function(item) {
                    return item.trim();
                }).join(', ').slice(0, -2);
                                    if(variants.indexOf(98)>-1){variantCount--}
                if(variants.indexOf(99)>-1){variantCount--}
                if(variants.indexOf('YY')>-1){variantCount--}
                if(variants.indexOf('YN')>-1){variantCount--}
                if(variants.indexOf('YK')>-1){variantCount--}
                if(variants.trim()===""){variantCount=0}
                var inOrEx = 'Intern';
                if(val.catalog.split('.')[0].indexOf('XXXL')>-1){
                    intern++;
                } else {
                    extern++;
                    inOrEx = 'Extern';
                }
                // check if catalog is in combined registry
                var inRegistry = 'Nein', inRegOrNot = 'falseCol';
                var isInRegistry = combinedRegistry.some(item => item.ID.toLowerCase() === val.catalog.toLowerCase() && item.Markets.includes(val.locale.toLowerCase()));
                if(isInRegistry){
                    inRegistry = 'Ja';
                    inRegOrNot = 'trueCol';
                }
                $('#myTable').append(
                    '<tr variants="'+variantCount+'"><td>'+val.catalog.split('.')[0].replace('XXXL', '')+'</td>'+
                    '<td>'+val.brandName+'</td>'+
                    '<td>'+val.modelName+'</td>'+
                    '<td>'+val.catalog+'</td>'+
                    '<td class="'+inOrEx+'">'+inOrEx+'</td>'+
                    '<td><a href="https://'+storeUrl+'/s/?s='+val.productNumber+'" target="_blank">'+val.productNumber+'</a></td>'+
                    '<td class="'+inRegOrNot+'">'+inRegistry+'</td>'+
                    '<td>'+variants+'</td>'+
                    '<td>'+variantCount+'</td>'+
                    '<td>'+val.brand+'</td>'+
                    '<td>'+val.locale+'</td>'+
                    '<td>'+val.currency+'</td>'+
                    '<td>'+val.preis+'</td>'+
                    '<td>'+val.entlasgung+'</td>'+
                    '<td>'+val.aktion+'</td>'+
                    '<td>'+val.description+'</td>'+
                    '<td>'+val.productGroup+'</td></tr>'
                )
            })
            // filterTable();
            $('.loading').removeClass('loading');
            countColumns()
            jQuery('#myTable').ddTableFilter();
        });
    }
    function getRegistryJson(){
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry-moebelix.json", function( data ) {
            combineRegistries(data, 'moebelix');
        });
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry-moemax.json", function( data ) {
            combineRegistries(data, 'moemax');
        });
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry-xxxl.json", function( data ) {
            combineRegistries(data, 'xxxl');
        });
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry.json", function( data ) {
            combineRegistries(data, 'registry');
        });
        readAndShowJSON();
    }
    getRegistryJson();
</script>
</html>