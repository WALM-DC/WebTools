<html>
<head>
    <title>IG-Asset-Liste</title>
    <link rel="stylesheet" href="https://walm-dc.github.io/WebTools/public/mattStyle.css">
    <script src="https://walm-dc.github.io/WebTools/public/jquery-3.7.1.min.js"></script>
    <script src="https://walm-dc.github.io/WebTools/public/ddtf.js"></script>
    <script src="https://walm-dc.github.io/WebTools/public/mattQuery.js"></script>
    <!-- <script src="mattQuery.js"></script> -->
    <style>
        .loading {
            background-image: url(https://walm-dc.github.io/WebTools/public/loading.gif);
            background-repeat: no-repeat;
            min-height: 600px;
            background-position: center;
            background-size: 600px auto;
        }
    </style>
</head>
<body>
    <div id="topDiv"></div>
    <div class="masterDiv">
        <!-- <div class="topDiv">
            <h2>XML-Liste</h2>
        </div> -->
        <div>
            <div class="resultDiv">
                <h3>Anzahl in der aktuellen Auflistung: <span id="myCounter"></span></h3>
                <img src="refresh-button.png" class="emptySearch" title="Suche leeren" alt="Suche leeren"><input type="text" id="myInput" placeholder="Allgemeine Suche auf alle Felder...">
                <div class="div_before_table igServer loading">
                    <table id="myTable" cellspacing="0" cellpadding="0">
                        <tr>
                            <th>Lieferant</th>
                            <th>Herkunft</th>
                            <th>Modell</th>
                            <th>Textur</th>
                            <th>Farbe</th>
                            <th>Zusammensetzung</th>
                        </tr>
                    </table>
                </div>
            </div>    
        </div>
    </div>
</body>
<script>
    injectTabs();

    var fullAssetList = [], stoffList = [];
    function countColumns(){
        $('#myCounter').html(($('table tr').length-1)-($('table tr[style="display: none;"]').length));
    }
    function sortList(a, b) {
        let ca = a.lieferant.toLowerCase();
        let cb = b.lieferant.toLowerCase();
        let da = a.modell.toLowerCase();
        let db = b.modell.toLowerCase(); 
        let ta = a.textur.toLowerCase();   
        let tb = b.textur.toLowerCase();
        if(ca !== cb) return (ca < cb) ? -1 : 1;
        if(da !== db) return (da < db) ? -1 : 1;
        if(ta !== tb) return (ta < tb) ? -1 : 1;
    }
    $('#myInput').on('keydown', function(e) {
        if (e.which === 13) { // Check if the Enter key is pressed (key code 13)
            if($(this).val() === ""){
                removeHighlights();
                $('#myTable tr').show();
            } else {
                filterTable();
            }
        }
    });
    $('.emptySearch').on('click', function(){
        $('#myInput').val('');
        removeHighlights();
        $('#myTable tr').show();
        jQuery('#myTable').ddTableFilter();
        readAndShowJSON(true);
    });
    function readAndShowJSON(){
        $.get('https://walm-dc.github.io/WebTools/public/Stoffe.csv', function(data) {
            var lines = data.split('\n');
            $.each(lines, function(id, val){
                if(val !== ''){
                    var parts = val.split(',');
                    stoffList.push({
                        "lieferantNr": parts[2],
                        "lieferantName": parts[3],
                        "modell": parts[5],
                        "stoff": parts[6],
                        "farbe": parts[7],
                        "zusammensetzung": parts[8]
                    });
                }
            });
        });
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/assets.json", function( data ) {
            $.each(data, function(id, val){
                var assetEntry = val.replace('D:\\inetpub\\wwwroot\\icom\\ICOM\\gfx\\', '').split('\\');
                var entry = {
                        "lieferant": assetEntry[0].replace('XXXL', ''),
                        "inOrExtern": assetEntry[0].indexOf('XXXL') === -1 ? 'intern' : 'extern',
                        "modell": assetEntry[1],
                        "textur": assetEntry[2],
                        "fileName": assetEntry[3]
                    }
                const isDuplicate = fullAssetList.some(item => item.textur.toLowerCase() === entry.textur.toLowerCase());
                if (!isDuplicate) {
                    fullAssetList.push(entry)
                } 
            });
            fullAssetList.sort(sortList);
            $.each(fullAssetList, function(id, val){
                var inOrEx = val.inOrExtern === 'intern' ? 'Intern' : 'Extern';
                var farbe = '', zusammensetzung = '';
                $.each(stoffList, function(sId, sVal){
                    if(sVal.modell.toLowerCase() === val.modell.toLowerCase() && sVal.stoff.toLowerCase() === val.textur.toLowerCase() && (sVal.lieferantNr === val.lieferant||sVal.lieferantName.toLowerCase() === val.lieferant.toLowerCase())){
                        farbe = sVal.farbe;
                        zusammensetzung = sVal.zusammensetzung;
                        return false; // break loop
                    }
                })
                $('#myTable').append(
                    '<tr><td>'+val.lieferant+'</td>'+
                    '<td class="'+inOrEx+'">'+val.inOrExtern+'</td>'+
                    '<td>'+val.modell+'</td>'+
                    '<td>'+val.textur+'</td>'+
                    '<td>'+farbe+'</td>'+
                    '<td>'+zusammensetzung+'</td></tr>'
                )
            });
            jQuery('#myTable').ddTableFilter();
            countColumns();
        });
    }
    readAndShowJSON();
</script>
</html>