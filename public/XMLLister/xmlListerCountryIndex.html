<html>
<head>
    <title>XML-Liste-Country</title>
    <link rel="stylesheet" href="https://walm-dc.github.io/WebTools/public/mattStyle.css">
    <script src="https://walm-dc.github.io/WebTools/public/jquery-3.7.1.min.js"></script>
    <script src="https://walm-dc.github.io/WebTools/public/ddtf.js"></script>
    <script src="https://walm-dc.github.io/WebTools/public/mattQuery.js"></script>
    <!-- <script src="mattQuery.js"></script> -->
    <style>
        .clickMe{
            cursor: pointer;
            background-color: darkorange;
            text-align: center;
            border-radius: 7px;
        }
        .clickMe:hover{
            color: white;
            background-color: darkcyan;
        }
    </style>
</head>
<body>
    <div id="topDiv"></div>
    <div class="masterDiv">
        <!-- <div class="topDiv">
            <h2>XML-Liste-Country</h2>
        </div> -->
        <div>
            <div class="resultDiv">
                <h3>Anzahl in der aktuellen Auflistung: <span id="myCounter"></span></h3>
                <input type="text" id="myInput" onkeyup="filterTable()" placeholder="Allgemeine Suche auf alle Felder...">
                <div class="div_before_table">
                    <table id="myTable" cellspacing="0" cellpadding="0">
                        <tr>
                            <th>XML-Name</th>
                            <th>Land</th>
                            <th>Hersteller</th>
                            <th>Lieferant</th>
                            <th>Modellname</th>
                            <th>In Registry</th>
                            <th>Target_ID</th>
                            <th>Catalog_ID</th>
                        </tr>
                    </table>
                </div>
            </div>    
        </div>
    </div>
</body>
<script>
    injectTabs();

    var langCheck = ['AT', 'DE', 'CH', 'CZ', 'SK', 'FR', 'SE', 'HU', 'SI', 'PL', 'RO'];
    var combinedRegistry = [];
    function countColumns(){
        $('#myCounter').html(($('table tr').length-1)-($('table tr[style="display: none;"]').length));
    }

    function filterTable() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("myInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("myTable");
        tr = table.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td");
            for (var j = 0; j < td.length; j++) {
            txtValue = td[j].textContent || td[j].innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
                break;
            } else {
                tr[i].style.display = "none";
            }
            }
        }
        countColumns()
    }

    function openXML(clickedElement){
        var xmlName = $(clickedElement).attr('name');
        var xmlPath = 'https://ig-creator.xxxlgroup.com/idm/'+xmlName+'.xml';

        $.ajax({
                type: "GET",
                url: xmlPath,
                dataType: "xml",

                error: function (e) {
                    alert("An error occurred while processing XML file");
                    console.log("XML reading Failed: ", e);
                },

                success: function (response) {
                    var dataArray = [], openXMLData = {}, openXMLName = '', openXMLTarget = '';
                    $(response).find('TARGET').each(function () {
                        openXMLData = {
                            Target_ID: $(this).find('TARGET_ID').text(),
                            Country_ID: $(this).find('NAME').text()
                        }
                        dataArray.push(openXMLData);
                        
                    })
                    dataArray.sort(function(a, b){if(a.Country_ID < b.Country_ID){return -1} if(a.Country_ID > b.Country_ID){return 1} return 0})
                    $.each(dataArray, function(id, val){
                        openXMLTarget += val.Target_ID+'<br>';
                        openXMLName += val.Country_ID+'<br>';
                        // $('#target_'+xmlName).html(val.Target_ID);
                        // $('#'+xmlName).html(val.Country_ID);
                    })
                    $('#target_'+xmlName).html(openXMLTarget)
                    $('#'+xmlName).html(openXMLName)
                }
            })
    }

    function formatNameAndCheckDupes(addressName){
        var entry = addressName.replace('https://ig-creator.xxxlgroup.com/idm/', '').split('*')[0];
        $.inArray(entry, combinedRegistry) === -1 ? combinedRegistry.push(entry) : null;
    }
    function combineRegistries(curRegistry, fileName){
        $.each(curRegistry.Domains, function( key, value ) {
            if(value.ComService === undefined) return; //skip entries without address
            if(value.ComService.Setups === undefined){
                formatNameAndCheckDupes(value.ComService.Address);
            } else {
                $.each(value.ComService.Setups, function( setupKey, setupValue ) {
                    formatNameAndCheckDupes(setupValue.Address);
                });
            }
        });
    }
    function removeAfterLastUnderscore(inputString) {
        const lastUnderscoreIndex = inputString.lastIndexOf('_');
        return lastUnderscoreIndex !== -1 ? inputString.substring(0, lastUnderscoreIndex + 1) : inputString;
    }
    function readAndShowJSON(){
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry-moebelix.json", function( data ) {
            combineRegistries(data, 'moebelix');
        });
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry-moemax.json", function( data ) {
            combineRegistries(data, 'moemax');
        });
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry-xxxl.json", function( data ) {
            combineRegistries(data, 'xxxl');
        });
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry.json", function( data ) {
            combineRegistries(data, 'registry');
        });
        $.getJSON( "https://ig-creator.xxxlgroup.com/idm/index.json", function( data ) {
            $.each(data, function(id, val){
                var land = '', inRegistry = '<td class="falseCol">Nein</td>';
                var splitVal = val.split('_');
                var shortXmlName = removeAfterLastUnderscore(val);

                if(langCheck.indexOf(splitVal[splitVal.length - 2]) > -1){
                    land = splitVal[splitVal.length - 2];
                }
                if($.inArray(shortXmlName, combinedRegistry) > -1){
                    inRegistry = '<td class="trueCol">Ja</td>';
                }
                $('#myTable').append(
                    '<tr><td>'+val+'</td>'+
                    '<td>'+land+'</td>'+
                    '<td>'+splitVal[0]+'</td>'+
                    '<td>'+splitVal[1]+'</td>'+
                    '<td>'+splitVal[2]+'</td>'+
                    inRegistry+
                    '<td id="target_'+val+'" style="width:100px" class="alignRight"></td>'+
                    '<td id="'+val+'"><div class="clickMe" onClick="openXML(this)" name="'+val+'">Load Country-Data</div></td></tr>'
                )
            })
            filterTable();
            jQuery('#myTable').ddTableFilter();
        });
    }
    readAndShowJSON();
</script>
</html>