<html>
<head>
    <title>Registry-Liste</title>
    <link rel="stylesheet" href="https://walm-dc.github.io/WebTools/public/mattStyle.css">
    <script src="https://walm-dc.github.io/WebTools/public/jquery-3.7.1.min.js"></script>
    <script src="https://walm-dc.github.io/WebTools/public/ddtf.js"></script>
    <script src="https://walm-dc.github.io/WebTools/public/mattQuery.js"></script>
    <!-- <script src="mattQuery.js"></script> -->
    <style>
              
    </style>
</head>
<body>
    <div id="topDiv"></div>
    <div class="masterDiv">
        <!-- <div class="topDiv">
            <h2>Registry-Liste</h2>
        </div> -->
        <div>
            <div class="resultDiv">
                <h3>Anzahl in der aktuellen Auflistung: <span id="myCounter"></span></h3>
                <input type="text" id="myInput" onkeyup="filterTable()" placeholder="Allgemeine Suche auf alle Felder...">
                <div class="div_before_table">
                    <table id="myTable" cellspacing="0" cellpadding="0">
                        <tr>
                            <th>ID</th>
                            <th>Marke</th>
                            <th>Modellname</th>
                            <th>3D Domain</th>
                            <th>Schiene</th>
                            <th>Address + Markets</th>
                        </tr>
                    </table>
                </div>
            </div>    
        </div>
    </div>
</body>
<script>
    injectTabs();

    var langCheck = ['AT', 'DE', 'CH', 'CZ', 'SK', 'FR', 'SE', 'HU', 'SI', 'PL', 'RO'];
    var combinedRegistry = [];
    function countColumns(){
        $('#myCounter').html(($('table tr').length-1)-($('table tr[style="display: none;"]').length));
    }

    function filterTable() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("myInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("myTable");
        tr = table.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td");
            for (var j = 0; j < td.length; j++) {
                txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                    break;
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
        countColumns()
    }
    function combineRegistries(curRegistry, fileName){
        $.each(curRegistry.Domains, function( key, value ) {
            var addressArray = [], marketArray = [];
            if(value.ComService === undefined) return; //skip entries without address
            var entry = {};
            if(value.ComService.Setups === undefined){
                $(value.ComService.Markets).each(function(mIndex, mValue) {
                    $.each(mValue, function(key, val) {
                        marketArray.push(`${key}: ${val}`);
                    });
                });
                addressArray.push(value.ComService.Address.replace('https://ig-creator.xxxlgroup.com/idm/', '')+'<br>Markets: '+marketArray.join(', '));
            } else {
                addressArray = [];
                $.each(value.ComService.Setups, function( setupKey, setupValue ) {
                        marketArray = [];
                    $(setupValue).each(function(mIndex, mValue) {
                        $.each(mValue.Markets, function(key, val) {
                            marketArray.push(`${key}: ${val}`);
                        });
                    });
                    addressArray.push(setupValue.Address.replace('https://ig-creator.xxxlgroup.com/idm/', '')+'<br>Markets: '+marketArray.join(', '));
                });
            }
            entry = {
                ID: key,
                FileName: fileName,
                Scope: value.Scope,
                Address: addressArray
            }

            const isDuplicate = combinedRegistry.some(item => item.ID.toLowerCase() === entry.ID.toLowerCase());

            if (!isDuplicate) {
                combinedRegistry.push(entry);
            }
        })
        if(fileName === 'registry'){
            $.each(combinedRegistry, function( index, registryEntry ) {
                $('#myTable').append('<tr>'+
                    '<td>'+registryEntry.ID+'</td>'+
                    '<td>'+registryEntry.Scope.split('.')[0]+'</td>'+
                    '<td>'+registryEntry.Scope.split('.')[1]+'</td>'+
                    '<td>'+registryEntry.Scope+'</td>'+
                    '<td>'+registryEntry.FileName+'</td>'+
                    '<td>'+registryEntry.Address.join('<br>')+'</td>'+
                '</tr>');
            });
            jQuery('#myTable').ddTableFilter();
            countColumns()
        }
    }
    function readAndShowJSON(){
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry-moebelix.json", function( data ) {
            combineRegistries(data, 'moebelix');
        });
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry-moemax.json", function( data ) {
            combineRegistries(data, 'moemax');
        });
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry-xxxl.json", function( data ) {
            combineRegistries(data, 'xxxl');
        });
        $.getJSON( "https://ig-creator.xxxlgroup.com/icom/ICOM/_registry.json", function( data ) {
            combineRegistries(data, 'registry');
        });
    }
    readAndShowJSON();
</script>
</html>