<html>
<head>
    <title>3D-Modell-Detail&uuml;bersicht</title>    
    <link rel="stylesheet" href="https://walm-dc.github.io/WebTools/public/mattStyle.css">
    <script src="https://walm-dc.github.io/WebTools/public/jquery-3.7.1.min.js"></script>
    <script src="https://walm-dc.github.io/WebTools/public/table2csv.js"></script>
    <script src="https://walm-dc.github.io/WebTools/public/ddtf.js"></script>
    <script src="https://walm-dc.github.io/WebTools/public/mattQuery.js"></script>
    <style>
        .loading {
            background-image: url(XMLLister/loading.gif);
            background-repeat: no-repeat;
            min-height: 600px;
            background-position: center;
            background-size: 600px auto;
        }
    </style>
</head>
<body>
    <div id="topDiv"></div>
    <div class="masterDiv">
        <!-- <div class="topDiv">
            <h2>3D-Modell-Detail&uuml;bersicht</h2>
        </div> -->
        <div>
            <div class="resultDiv">
                <h3>Anzahl der gefilterten Artikel: <span id="myCounter"></span></h3>
                <h3>Anzahl der Varianten / Absprungpunkte: <span id="myVariantCounter"></span></h3>
                <h3 class="withButton">CSV Export: 
                    <button id="exportAll" class="pushable">
                        <span class="front">Alle Daten</span>
                    </button>
                    <button id="exportFiltered" class="pushable">
                        <span class="front">Gefilterte Daten</span>
                    </button>
                </h3>
                <img src="refresh-button.png" class="emptySearch" title="Suche leeren" alt="Suche leeren"><input type="text" id="myInput" placeholder="Allgemeine Suche auf alle Felder...">
                <div class="div_before_table loading">
                    <table id="myTable" cellspacing="0" cellpadding="0">
                        <tr id="headerRow">
                            <th>Hersteller</th>
                            <th>Marke</th>
                            <th>Modellname</th>
                            <th>3D Domain</th>
                            <th>Herkunft</th>
                            <th>Nummer</th>
                            <th>Online</th>
                            <th>Konfig.</th>
                            <th>Schiene</th>
                            <th>Land</th>
                            <th>Properties</th>
                        </tr>
                    </table>
                </div>
            </div>    
        </div>
    </div>
</body>
<script>
    injectTabs();

    var intern = 0, extern = 0, propTableHeader = [];
    var countryShorts = {
        "LU": "xxxlutz",
        "MM": "moemax",
        "MX": "moebelix"
    }
    function sortList(a, b) {
        let ca = a.catalog.split('.')[0].replace('XXXL', '').toLowerCase();
        let cb = b.catalog.split('.')[0].replace('XXXL', '').toLowerCase();
        let ba = a.brandName.toLowerCase();
        let bb = b.brandName.toLowerCase();
        let ma = a.modelName.toLowerCase();
        let mb = b.modelName.toLowerCase();
        if(ca !== cb) return (ca < cb) ? -1 : 1;
        if(ba !== bb) return (ba < bb) ? -1 : 1;
        return (ma < mb) ? -1 : 1;
    }
    function countColumns(){
        $('#myCounter').html(($('table tr').length-1)-($('table tr[style="display: none;"]').length));
        var allVarantCount = 0, inactiveVariantCount = 0;
        $.each($('table tr'),function(id, val){
            if(typeof($(val).attr('variants'))!='undefined'){
                allVarantCount += parseInt($(val).attr('variants'));
            }
        })
        $.each($('table tr[style="display: none;"]'),function(id, val){
            if(typeof($(val).attr('variants'))!='undefined'){
                inactiveVariantCount += parseInt($(val).attr('variants'));
            }
        })
        $('#myVariantCounter').html(allVarantCount-inactiveVariantCount);
    }
    function removeHighlights() {
        $("mark").each(function() {
            // Replace the <mark> tag with its inner text
            $(this).replaceWith($(this).text());
        });
    }
    function highlightOccurrences(searchString) {
        // Loop through all elements on the page
        removeHighlights();
        const regex = new RegExp(searchString, "gi");
        $("body *").contents().each(function() {
            if (this.nodeType === 3) { // Only process text nodes
                const text = $(this).text();
                    // Case-insensitive search

                // Replace occurrences with <mark>
                const highlightedText = text.replace(regex, function(match) {
                    return `<mark>${match}</mark>`;
                });
                $(this).replaceWith(highlightedText);
            }
        });
    }
    function filterTable() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("myInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("myTable");
        tr = table.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td");
            for (var j = 0; j < td.length; j++) {
                txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                    break;
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
        countColumns();
        highlightOccurrences(filter);
    }
    $('#myInput').on('keydown', function(e) {
        if (e.which === 13) { // Check if the Enter key is pressed (key code 13)
            if($(this).val() === ""){
                resetFilters();
                $('#myTable tr').show();
            } else {
                filterTable();
            }
        }
    });
    $('.emptySearch').on('click', function(){
        $('#myInput').val('');
        removeHighlights();
        $('#myTable tr').show();
        countColumns();
    });
    // docu for plugin: https://www.jqueryscript.net/table/jQuery-Plugin-To-Export-Table-Data-To-CSV-File-table2csv.html
    $('#exportAll').on('click',function(){
        $("table").table2csv({  
            filename:'3D-Modellliste.csv',
            separator: ';',
            newline: '\n',
            quoteFields: false,
            trimContent: true,
            excludeHidden: false          
        });
    })
    $('#exportFiltered').on('click',function(){
        $("table").table2csv({
            filename:'3D-Modellliste-gefiltert.csv',
            separator: ';',
            newline: '\n',
            quoteFields: false,
            trimContent: true,
            excludeHidden: true
        });
    })
    function readAndShowJSON(){
        $.getJSON( "https://walm-dc.github.io/WebTools/public/list.json", function( data ) {
            var sortArray = $.map(data, function(value, index) {return [value]});
            sortArray.sort(sortList);
            $.each(sortArray, function(id, val){
                var online = '<td class="trueCol">Ja</td>';
                if(val.online=='false'){online = '<td class="falseCol">Nein</td>'}
                if(val.online==''){online = '<td></td>'}
                var konfig = '<td class="trueCol">Ja</td>';
                if(val.konfig=='false'){konfig = '<td class="falseCol">Nein</td>'}
                if(val.konfig==''){konfig = '<td></td>'}
                var storeUrl = countryShorts[val.brand]+'.'+val.locale;
                if(countryShorts[val.brand] === 'xxxlutz' && val.locale === 'si'){
                    storeUrl = 'xxxlesnina'+'.'+val.locale;
                }
                var variantCount = val.productVariants.split("/").length;
                var variants = val.productVariants.split('/').map(function(item) {
                    return item.trim();
                }).join(', ').slice(0, -2);
                                    if(variants.indexOf(98)>-1){variantCount--}
                if(variants.indexOf(99)>-1){variantCount--}
                if(variants.indexOf('YY')>-1){variantCount--}
                if(variants.indexOf('YN')>-1){variantCount--}
                if(variants.indexOf('YK')>-1){variantCount--}
                if(variants.trim()===""){variantCount=0}
                var inOrEx = 'Intern';
                if(val.catalog.split('.')[0].indexOf('XXXL')>-1){
                    intern++;
                } else {
                    extern++;
                    inOrEx = 'Extern';
                }
                var propTable = '';
                $.each(val.properties, function(propId, propVal){
                    propTable += propVal.name+': <ul>';
                    $.each(propVal.values, function(valuesId, valuesVal){
                        propTable += '<li>'+valuesVal.name+'-'+valuesVal.value+'</li>';
                    })
                    propTable += '</ul>';
                })
                $('#myTable').append(
                    '<tr variants="'+variantCount+'"><td>'+val.catalog.split('.')[0].replace('XXXL', '')+'</td>'+
                    '<td>'+val.brandName+'</td>'+
                    '<td>'+val.modelName+'</td>'+
                    '<td>'+val.catalog+'</td>'+
                    '<td class="'+inOrEx+'">'+inOrEx+'</td>'+
                    '<td><a href="https://'+storeUrl+'/s/?s='+val.productNumber+'" target="_blank">'+val.productNumber+'</a></td>'+
                    online+
                    konfig+
                    '<td>'+val.brand+'</td>'+
                    '<td>'+val.locale+'</td>'+
                    '<td>'+propTable+'</td>'
                )
            })
            $('.loading').removeClass('loading');
            countColumns();
            jQuery('#myTable').ddTableFilter();
        });
    }
    readAndShowJSON();
</script>
</html>